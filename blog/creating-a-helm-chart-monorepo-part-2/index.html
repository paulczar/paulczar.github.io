<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Paul Czarkowski">
    <link rel="shortcut icon" type="image/x-icon" href="https://tech.paulcz.net/img/favicon.ico">
    <title>Creating a Helm Chart Repository - Part 2 | Paul Czarkowski</title>
    <meta name="description" content="Introduction Welcome to a three part blog series on Creating a Helm Chart Repository. In part 1 of this series I demonstrated creating a Helm chart repository using GitHub and GitHub Pages. In this part 2 I will add Automation to automatically update the repository, and in part 2 I will add testing for changes to the charts themselves.
If you&rsquo;re into Videos, I walked JJ through starting with Helm from scratch all the way to creating a Helm Repo and CI/CD.">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    
    <link rel="preload stylesheet" href="/css/main.min.css" as="style">
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,400,200bold,400old">
    
    <!--[if lt IE 9]>
			<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
			<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
  
    
      
    
  


  </head>
  <body>
    <div id="content">
  
  <nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="https://tech.paulcz.net/"><i class="fa fa-home"></i></a>
    </div>
    <div id="navbar">
      <ul class="nav navbar-nav navbar-right">
      
        
        <li><a href="/page/about">ABOUT</a></li>
        
        <li><a href="/blog/">BLOG</a></li>
        
        <li><a href="/page/resume">RESUME</a></li>
        
        <li><a href="https://speaking.paulcz.net/presentations">TALK</a></li>
        
      
      </ul>
    </div>
  </div>
</nav>


  <div class="container">
    <h3 class="mt-3"><b><a href="https://tech.paulcz.net/blog/creating-a-helm-chart-monorepo-part-2/">Creating a Helm Chart Repository - Part 2</a></b></h3>
    <div class="blog-title my-4">
      <h6>
        July 3, 2019
        &nbsp;&nbsp;
        
      </h6>
    </div>
    <div class="panel">
      <div class="panel-body">
        <div class="blogpost">
          <h2 id="introduction">Introduction</h2>
<p>Welcome to a three part blog series on Creating a <a href="https://helm.sh">Helm</a> Chart Repository. In <a href="/blog/creating-a-helm-chart-monorepo-part-1">part 1</a> of this series I demonstrated creating a <a href="https://helm.sh">Helm</a> chart repository using <a href="https://github.com">GitHub</a> and <a href="https://github.com">GitHub</a> Pages. In this <strong>part 2</strong> I will add Automation to automatically update the repository, and in <a href="/blog/creating-a-helm-chart-monorepo-part-3">part 2</a> I will add testing for changes to the charts themselves.</p>
<blockquote>
<p>If you&rsquo;re into Videos, I walked JJ through starting with Helm from scratch all the way to creating a Helm Repo and CI/CD.  <div class="embed video-player">
<iframe class="youtube-player" type="text/html" width="640" height="385" src="http://www.youtube.com/embed/xn63krHJNKI" allowfullscreen frameborder="0">
</iframe>
</div>
</p>
</blockquote>
<h2 id="use-circle-ci-to-automate-helmhttpshelmsh-chart-updates">Use Circle CI to automate <a href="https://helm.sh">Helm</a> Chart Updates</h2>
<blockquote>
<p>Note: While I would usually use <a href="https://concourse-ci.org/">Concourse CI</a> for my CI workflows, I wanted to <em>only</em> use managed services and I chose Circle as that is already commonly used in the Helm community. It would be trivial to whip up a Concourse Pipeline to do the same thing.</p>
</blockquote>
<p>Now that we&rsquo;ve successfully created a <a href="https://helm.sh">Helm</a> Chart Repostiory using <a href="https://github.com">GitHub</a> and <a href="https://github.com">GitHub</a> pages we can move on to adding some Automation so that our Chart Repository is updated any time we push changes up to our master branch.</p>
<p>Its pretty easy to create a new Circle CI account. You simply go to their website and hit <a href="https://circleci.com/signup/">sign-up</a>, it will ask you to log using <a href="https://github.com">GitHub</a>Oauth2 and once you&rsquo;ve given it access to your repositories you are good to go.</p>
<p>Once logged in you need to hit the <strong>ADD Projects</strong> menu item and hit the <strong>set up project</strong> button next to <strong>my-helm-charts</strong>.</p>
<p><img src="circle-add-project.png" alt="add project"></p>
<p>You can leave the defaults and just go down and click the <strong>Start Building</strong> button.</p>
<p>It will attempt to run and fail because you don&rsquo;t have a <code>.circleci/config.yml</code> file in your repo yet. We&rsquo;ll create that soon.</p>
<p>Before we do that though we need to create a private key for Circle CI with write access to our project. Hit the <strong>settings</strong> button on the top right of the <strong>Workflows -&gt; username -&gt; my-helm-charts</strong> screen tat looks like a little cog.</p>
<p>From here you want to hit SSH permissions and hit <strong>Checkout SSH Keys</strong>.</p>
<p>There should be a <strong>Add user key</strong> section with a button that says <strong>Authorize with GitHub</strong>, hit that button. To be extra certain it loads the same page and you need to click the <strong>Create and add [username] user key</strong> which will create a key and pass the public key off to github.</p>
<p>On that same <strong>settings</strong> page you need to add some environment variables:</p>
<p><img src="./circle-env-vars.png" alt="circle env vars"></p>
<p>Now its time to set up our Automation.</p>
<h3 id="create-circle-ci-config-for-uploading-new-packages">Create Circle CI config for uploading new packages</h3>
<p>Create a new directory <code>.circleci</code> and a file inside that called <code>config.yml</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ mkdir .circleci
</span></span><span style="display:flex;"><span>$ touch .circleci/config.yml
</span></span></code></pre></div><p>Write out the <code>config.yml</code> file like so:</p>
<blockquote>
<p>Note: this CircleCI config file creates two jobs, One to lint the shell scripts we&rsquo;re about to create, the other to release charts and copy documentation into our <a href="https://helm.sh">Helm</a> repo website. These tasks will run when code is pushed or merged into the <code>master</code> branch.</p>
</blockquote>
<h4 id="circleciconfigymlhttpsgithubcompaulczarmy-helm-chartsblobpart-2circleciconfigyml"><a href="https://github.com/paulczar/my-helm-charts/blob/part-2/.circleci/config.yml">.circleci/config.yml</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">jobs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">lint-scripts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">docker</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">koalaman/shellcheck-alpine</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">steps</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">checkout</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">run</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">lint</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">command</span>: <span style="color:#ae81ff">shellcheck -x .circleci/*.sh</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">release-charts</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">machine</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">steps</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">checkout</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">run</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">command</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            echo &#34;export GIT_REPOSITORY_URL=$CIRCLE_REPOSITORY_URL&#34; &gt;&gt; $BASH_ENV
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            echo &#34;export GIT_USERNAME=$CIRCLE_PROJECT_USERNAME&#34; &gt;&gt; $BASH_ENV
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            echo &#34;export GIT_REPOSITORY_NAME=$CIRCLE_PROJECT_REPONAME&#34; &gt;&gt; $BASH_ENV
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            .circleci/install_tools.sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            .circleci/release.sh</span>            
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">workflows</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">release</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">jobs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">lint-scripts</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">release-charts</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">filters</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">tags</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">ignore</span>: <span style="color:#ae81ff">/.*/</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">branches</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">only</span>: <span style="color:#ae81ff">master</span>
</span></span></code></pre></div><p>We referenced two scripts in the <code>config.yml</code> file, so we better create those. These scripts are a mix of ones that I have written, and have borrowed from <a href="https://twitter.com/unguiculus">Reinhard Nägele</a> one of the main contributors to awesome tooling in the Helm Community as found <a href="https://github.com/codecentric/helm-charts/blob/master/.circleci/release.sh">here</a>.</p>
<blockquote>
<p>It&rsquo;s no surprise that these scripts came from <a href="https://twitter.com/unguiculus">Reinhard Nägele</a>as he is a primary maintainer of both <a href="https://github.com/helm/chart-testing">chart-testing</a> and <a href="https://github.com/helm/chart-releaser">chart-releaser</a>.</p>
</blockquote>
<h4 id="circleciinstall_toolsshhttpsgithubcompaulczarmy-helm-chartsblobpart-2circleciinstall_toolssh"><a href="https://github.com/paulczar/my-helm-charts/blob/part-2/.circleci/install_tools.sh">.circleci/install_tools.sh</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>set -o errexit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>readonly HELM_VERSION<span style="color:#f92672">=</span>2.13.1
</span></span><span style="display:flex;"><span>readonly CHART_RELEASER_VERSION<span style="color:#f92672">=</span>0.1.4
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Installing Helm...&#34;</span>
</span></span><span style="display:flex;"><span>curl -LO <span style="color:#e6db74">&#34;https://kubernetes-helm.storage.googleapis.com/helm-v</span>$HELM_VERSION<span style="color:#e6db74">-linux-amd64.tar.gz&#34;</span>
</span></span><span style="display:flex;"><span>sudo mkdir -p <span style="color:#e6db74">&#34;/usr/local/helm-v</span>$HELM_VERSION<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>sudo tar -xzf <span style="color:#e6db74">&#34;helm-v</span>$HELM_VERSION<span style="color:#e6db74">-linux-amd64.tar.gz&#34;</span> -C <span style="color:#e6db74">&#34;/usr/local/helm-v</span>$HELM_VERSION<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>sudo ln -s <span style="color:#e6db74">&#34;/usr/local/helm-v</span>$HELM_VERSION<span style="color:#e6db74">/linux-amd64/helm&#34;</span> /usr/local/bin/helm
</span></span><span style="display:flex;"><span>rm -f <span style="color:#e6db74">&#34;helm-v</span>$HELM_VERSION<span style="color:#e6db74">-linux-amd64.tar.gz&#34;</span>
</span></span><span style="display:flex;"><span>helm init --client-only
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;Installing chart-releaser...&#34;</span>
</span></span><span style="display:flex;"><span>curl -LO <span style="color:#e6db74">&#34;https://github.com/helm/chart-releaser/releases/download/v</span><span style="color:#e6db74">${</span>CHART_RELEASER_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">/chart-releaser_</span><span style="color:#e6db74">${</span>CHART_RELEASER_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">_Linux_x86_64.tar.gz&#34;</span>
</span></span><span style="display:flex;"><span>sudo mkdir -p <span style="color:#e6db74">&#34;/usr/local/chart-releaser-v</span>$CHART_RELEASER_VERSION<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>sudo tar -xzf <span style="color:#e6db74">&#34;chart-releaser_</span><span style="color:#e6db74">${</span>CHART_RELEASER_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">_Linux_x86_64.tar.gz&#34;</span> -C <span style="color:#e6db74">&#34;/usr/local/chart-releaser-v</span>$CHART_RELEASER_VERSION<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>sudo ln -s <span style="color:#e6db74">&#34;/usr/local/chart-releaser-v</span>$CHART_RELEASER_VERSION<span style="color:#e6db74">/chart-releaser&#34;</span> /usr/local/bin/chart-releaser
</span></span><span style="display:flex;"><span>rm -f <span style="color:#e6db74">&#34;chart-releaser_</span><span style="color:#e6db74">${</span>CHART_RELEASER_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">_Linux_x86_64.tar.gz&#34;</span>
</span></span></code></pre></div><h4 id="circlecireleaseshhttpsgithubcompaulczarmy-helm-chartsblobpart-2circlecireleasesh"><a href="https://github.com/paulczar/my-helm-charts/blob/part-2/.circleci/release.sh">.circleci/release.sh</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>set -o errexit
</span></span><span style="display:flex;"><span>set -o nounset
</span></span><span style="display:flex;"><span>set -o pipefail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>CH_TOKEN:?Environment variable CH_TOKEN must be set<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GIT_REPOSITORY_URL:?Environment variable GIT_REPO_URL must be set<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GIT_USERNAME:?Environment variable GIT_USERNAME must be set<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GIT_EMAIL:?Environment variable GIT_EMAIL must be set<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>: <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>GIT_REPOSITORY_NAME:?Environment variable GIT_REPOSITORY_NAME must be set<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>readonly REPO_ROOT<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>REPO_ROOT<span style="color:#66d9ef">:-$(</span>git rev-parse --show-toplevel<span style="color:#66d9ef">)</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    pushd <span style="color:#e6db74">&#34;</span>$REPO_ROOT<span style="color:#e6db74">&#34;</span> &gt; /dev/null
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Fetching tags...&#34;</span>
</span></span><span style="display:flex;"><span>    git fetch --tags
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    local latest_tag
</span></span><span style="display:flex;"><span>    latest_tag<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>find_latest_tag<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    local latest_tag_rev
</span></span><span style="display:flex;"><span>    latest_tag_rev<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>git rev-parse --verify <span style="color:#e6db74">&#34;</span>$latest_tag<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;</span>$latest_tag_rev<span style="color:#e6db74"> </span>$latest_tag<span style="color:#e6db74"> (latest tag)&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    local head_rev
</span></span><span style="display:flex;"><span>    head_rev<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>git rev-parse --verify HEAD<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;</span>$head_rev<span style="color:#e6db74"> HEAD&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> <span style="color:#e6db74">&#34;</span>$latest_tag_rev<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;</span>$head_rev<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;No code changes. Nothing to release.&#34;</span>
</span></span><span style="display:flex;"><span>        exit
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    rm -rf .deploy
</span></span><span style="display:flex;"><span>    mkdir -p .deploy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Identifying changed charts since tag &#39;</span>$latest_tag<span style="color:#e6db74">&#39;...&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    local changed_charts<span style="color:#f92672">=()</span>
</span></span><span style="display:flex;"><span>    readarray -t changed_charts <span style="color:#f92672">&lt;&lt;&lt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>git diff --find-renames --name-only <span style="color:#e6db74">&#34;</span>$latest_tag_rev<span style="color:#e6db74">&#34;</span> -- charts | cut -d <span style="color:#e6db74">&#39;/&#39;</span> -f <span style="color:#ae81ff">2</span> | uniq<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -n <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>changed_charts[*]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> chart in <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>changed_charts[@]<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>            echo <span style="color:#e6db74">&#34;Packaging chart &#39;</span>$chart<span style="color:#e6db74">&#39;...&#34;</span>
</span></span><span style="display:flex;"><span>            package_chart <span style="color:#e6db74">&#34;charts/</span>$chart<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        release_charts
</span></span><span style="display:flex;"><span>        sleep <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>        update_index
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;Nothing to do. No chart changes detected.&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    popd &gt; /dev/null
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>find_latest_tag<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ! git describe --tags --abbrev<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> 2&gt; /dev/null; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        git rev-list --max-parents<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> --first-parent HEAD
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>package_chart<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    local chart<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    Helm dependency build <span style="color:#e6db74">&#34;</span>$chart<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    Helm package <span style="color:#e6db74">&#34;</span>$chart<span style="color:#e6db74">&#34;</span> --destination .deploy
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>release_charts<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    chart-releaser upload -o <span style="color:#e6db74">&#34;</span>$GIT_USERNAME<span style="color:#e6db74">&#34;</span> -r <span style="color:#e6db74">&#34;</span>$GIT_REPOSITORY_NAME<span style="color:#e6db74">&#34;</span> -p .deploy
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>update_index<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    chart-releaser index -o <span style="color:#e6db74">&#34;</span>$GIT_USERNAME<span style="color:#e6db74">&#34;</span> -r <span style="color:#e6db74">&#34;</span>$GIT_REPOSITORY_NAME<span style="color:#e6db74">&#34;</span> -p .deploy/index.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    git config user.email <span style="color:#e6db74">&#34;</span>$GIT_EMAIL<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    git config user.name <span style="color:#e6db74">&#34;</span>$GIT_USERNAME<span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> file in charts/*/*.md; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -e $file <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            mkdir -p <span style="color:#e6db74">&#34;.deploy/docs/</span><span style="color:#66d9ef">$(</span>dirname <span style="color:#e6db74">&#34;</span>$file<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>            cp --force <span style="color:#e6db74">&#34;</span>$file<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;.deploy/docs/</span><span style="color:#66d9ef">$(</span>dirname <span style="color:#e6db74">&#34;</span>$file<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    git checkout gh-pages
</span></span><span style="display:flex;"><span>    cp --force .deploy/index.yaml index.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -e <span style="color:#e6db74">&#34;.deploy/docs/charts&#34;</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        mkdir -p charts
</span></span><span style="display:flex;"><span>        cp --force --recursive .deploy/docs/charts/* charts/
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    git checkout master -- README.md
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ! git diff --quiet; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        git add .
</span></span><span style="display:flex;"><span>        git commit --message<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Update index.yaml&#34;</span> --signoff
</span></span><span style="display:flex;"><span>        git push <span style="color:#e6db74">&#34;</span>$GIT_REPOSITORY_URL<span style="color:#e6db74">&#34;</span> gh-pages
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main
</span></span></code></pre></div><p>Add these new files to git and push them up to the <code>master</code> branch:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ git add .
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git status
</span></span><span style="display:flex;"><span>On branch master
</span></span><span style="display:flex;"><span>Your branch is up to date with <span style="color:#e6db74">&#39;origin/master&#39;</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Changes to be committed:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">(</span>use <span style="color:#e6db74">&#34;git reset HEAD &lt;file&gt;...&#34;</span> to unstage<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  new file:   .circleci/config.yml
</span></span><span style="display:flex;"><span>  new file:   .circleci/install_tools.sh
</span></span><span style="display:flex;"><span>  new file:   .circleci/release.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git commit -m <span style="color:#e6db74">&#39;add circle ci scripts&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ git push origin master
</span></span></code></pre></div><p>This push should kick off a Circle CI job which will hopefully pass (I usually get it wrong the first few times).</p>
<p><img src="./circle-first-job.png" alt="circle first job"></p>
<p>You&rsquo;ll notice there&rsquo;s a failed job, that&rsquo;s because when circleci sees the releases being updated it tries to run a job for the <code>gh-pages</code> branch that doesn&rsquo;t have a circle-ci config. We can use this sweet git trick to grab the one from the master branch:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ git checkout gh-pages
</span></span><span style="display:flex;"><span>$ git pull origin gh-pages
</span></span><span style="display:flex;"><span>$ mkdir .circleci
</span></span><span style="display:flex;"><span>$ git checkout master -- .circleci/config.yml
</span></span><span style="display:flex;"><span>$ git add .circleci/config.yml
</span></span><span style="display:flex;"><span>$ git commit -m <span style="color:#e6db74">&#39;add circleci config&#39;</span>
</span></span><span style="display:flex;"><span>$ git push origin gh-pages
</span></span></code></pre></div><h3 id="validate-the-release-of-new-charts">Validate the release of new charts</h3>
<p>So far we haven&rsquo;t actually changed our <a href="https://helm.sh">Helm</a> Charts, so the automation hasn&rsquo;t created a new release. We can change this by bumping the chart version of one of them.  Edit <code>./charts/app1/Chart.yaml</code> and bump the version like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">appVersion</span>: <span style="color:#e6db74">&#34;1.0&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">description</span>: <span style="color:#ae81ff">A Helm chart for Kubernetes</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">app1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#ae81ff">0.1.1</span>
</span></span></code></pre></div><p>Push this change up:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ git add .
</span></span><span style="display:flex;"><span>$ git commit -m <span style="color:#e6db74">&#39;update app1 chart&#39;</span>
</span></span><span style="display:flex;"><span>$ git push origin master
</span></span></code></pre></div><p>You should see the new job show up in Circle and complete fairly quickly.</p>
<p>Once the job has completed successfully you can check you now have a <code>myapp-0.1.1</code> release in your <a href="https://github.com">GitHub</a>repo and your <a href="https://helm.sh">Helm</a> repository now has <code>myapp-0.1.1</code> in its <code>index.yaml</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl http://tech.paulcz.net/my-helm-charts/index.yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>entries:
</span></span><span style="display:flex;"><span>  app1:
</span></span><span style="display:flex;"><span>  - apiVersion: v1
</span></span><span style="display:flex;"><span>    appVersion: <span style="color:#e6db74">&#34;1.0&#34;</span>
</span></span><span style="display:flex;"><span>    created: <span style="color:#e6db74">&#34;2019-07-03T23:16:21.087774995Z&#34;</span>
</span></span><span style="display:flex;"><span>    description: A Helm chart <span style="color:#66d9ef">for</span> Kubernetes
</span></span><span style="display:flex;"><span>    digest: 9fbf6f9d10fba82aa3b749875e137b283890136a7379efba2bbff0b645cb1c35
</span></span><span style="display:flex;"><span>    name: app1
</span></span><span style="display:flex;"><span>    urls:
</span></span><span style="display:flex;"><span>    - https://github.com/paulczar/my-helm-charts/releases/download/app1-0.1.1/app1-0.1.1.tgz
</span></span><span style="display:flex;"><span>    version: 0.1.1
</span></span><span style="display:flex;"><span>  - apiVersion: v1
</span></span><span style="display:flex;"><span>    appVersion: <span style="color:#e6db74">&#34;1.0&#34;</span>
</span></span><span style="display:flex;"><span>    created: <span style="color:#e6db74">&#34;2019-07-03T23:16:21.376254864Z&#34;</span>
</span></span><span style="display:flex;"><span>    description: A Helm chart <span style="color:#66d9ef">for</span> Kubernetes
</span></span><span style="display:flex;"><span>    digest: 48cf831b72febeac2860a0be372094250aea68a9c76147c028085c8802dd48ec
</span></span><span style="display:flex;"><span>    name: app1
</span></span><span style="display:flex;"><span>    urls:
</span></span><span style="display:flex;"><span>    - https://github.com/paulczar/my-helm-charts/releases/download/app1-0.1.0/app1-0.1.0.tgz
</span></span><span style="display:flex;"><span>    version: 0.1.0
</span></span><span style="display:flex;"><span>  app2:
</span></span><span style="display:flex;"><span>  - apiVersion: v1
</span></span><span style="display:flex;"><span>    appVersion: <span style="color:#e6db74">&#34;1.0&#34;</span>
</span></span><span style="display:flex;"><span>    created: <span style="color:#e6db74">&#34;2019-07-03T23:16:21.22793015Z&#34;</span>
</span></span><span style="display:flex;"><span>    description: Helm chart <span style="color:#66d9ef">for</span> Kubernetes
</span></span><span style="display:flex;"><span>    digest: 64b00fc4804aba524201f64e78ee22ad8e61d0923424f8e24e8b70befed88141
</span></span><span style="display:flex;"><span>    name: app2
</span></span><span style="display:flex;"><span>    urls:
</span></span><span style="display:flex;"><span>    - https://github.com/paulczar/my-helm-charts/releases/download/app2-0.1.0/app2-0.1.0.tgz
</span></span><span style="display:flex;"><span>    version: 0.1.0
</span></span><span style="display:flex;"><span>generated: <span style="color:#e6db74">&#34;2019-07-03T23:16:20.624914794Z&#34;</span>
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>In <a href="/blog/creating-a-helm-chart-monorepo-part-1">Part 1</a> we created set of <a href="https://helm.sh">Helm</a> Charts managed in source control (GitHub) and in Part 2 we just added automation via CircleCI to automate building and deploying Chart packages to a <a href="https://helm.sh">Helm</a> Chart Repository hosted in <a href="https://github.com">GitHub</a> pages and <a href="https://github.com">GitHub</a>releases.</p>
<p>In <a href="/blog/creating-a-helm-chart-monorepo-part-3">Part 3</a> we will add further automation to test for changes in those <a href="https://helm.sh">Helm</a> charts and to pass them through rigorous testing before allowing them to be merged into the <code>master</code> branch.</p>

          
          
        </div>
      </div>
      <div class="disqus">
        
      </div>
    </div>
  </div>

    </div>
    
    <footer class="footer">
  <div class="container">
    <div class="text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io/">Hugo</a> and
    <a href="http://www.github.com/nurlansu/hugo-sustain/">sustain</a> with ♥</div>
  </div>
</footer>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.min.js" integrity="sha384-nsg8ua9HAw1y0W1btsyWgBklPnCUAFLuTMS2G72MMONqmOymq585AcH49TLBQObG" crossorigin="anonymous"></script>

  </body>
</html>
